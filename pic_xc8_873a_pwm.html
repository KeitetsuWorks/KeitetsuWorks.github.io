<!doctype html>
<!--
  Material Design Lite
  Copyright 2015 Google Inc. All rights reserved.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

    https://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License
-->
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="description" content="KeitetsuWorks - 16F873AとMPLAB XC8を用いたPWM方式LED調光回路の製作例を紹介します．16F873Aに搭載されているCCPモジュールのPWM機能を使用しています．">
    <title>KeitetsuWorks - 16F873A XC8開発例 - LED調光回路（CCPモジュールのPWM機能）</title>

    <link rel="shortcut icon" href="img/favicon.ico">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <link rel="stylesheet" href="css/styles.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.css">

    <link rel="stylesheet" href="css/monokai.css">

    <script src="js/common.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PSLDBJZ3HB"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-PSLDBJZ3HB');
    </script>
  </head>
  <body class="mdl-keitetsu mdl-color--grey-100 mdl-color-text--grey-700">
    <div class="mdl-layout mdl-js-layout">
      <header class="mdl-layout__header mdl-layout__header--waterfall">
        <!-- Top row, always visible -->
        <div class="mdl-layout__header-row">
          <!-- Title -->
          <span class="mdl-layout-title">KeitetsuWorks</span>
        </div>

        <!-- Tabs -->
        <div class="mdl-layout__tab-bar mdl-js-ripple-effect">
          <a class="mdl-layout__tab" href="index.html">トップページ</a>
          <a class="mdl-layout__tab" href="https://keitetsu.blogspot.com/" target="_blank">BLOG</a>
          <a class="mdl-layout__tab" href="mokei.html">鉄道模型</a>
          <a class="mdl-layout__tab is-active" href="circuit.html">電子工作</a>
          <a class="mdl-layout__tab" href="notebook.html">雑記</a>
        </div>
      </header>
      <div class="mdl-layout__drawer">
        <span class="mdl-layout-title">KeitetsuWorks</span>
        <nav class="mdl-navigation">
          <a class="mdl-navigation__link" href="index.html">トップページ</a>
          <a class="mdl-navigation__link" href="https://keitetsu.blogspot.com/" target="_blank">BLOG</a>
          <a class="mdl-navigation__link" href="mokei.html">鉄道模型</a>
          <a class="mdl-navigation__link is-active" href="circuit.html">電子工作</a>
          <a class="mdl-navigation__link" href="notebook.html">雑記</a>
        </nav>
      </div>
      <main class="mdl-layout__content">
        <div class="contents mdl-grid mdl-grid--no-spacing">
          <div class="mdl-cell mdl-cell--10-col-desktop mdl-cell--6-col-tablet mdl-cell--4-col-phone">
            <div class="mdl-grid">
              <section class="mdl-cell mdl-cell--12-col mdl-shadow--4dp article">
                <h3>16F873A XC8開発例 - LED調光回路（CCPモジュールのPWM機能）</h3>
                <h4>はじめに</h4>
                <p>
                  本ページでは，PIC16F873AとMPLAB XC8 C Compilerを使用した開発例として，PWM方式LED調光回路の製作例を紹介します．
                  LEDの輝度制御には，PIC16F873Aに搭載されているCCPモジュールのPWM機能を使用しています．
                  今回はPIC16F873Aを使用していますが，一部を変更することで，同様のCCPモジュールが搭載されているPIC16F877Aなどでも下記のプログラムを使用できると思います．
                </p>
                <p>
                  下記の環境で動作を確認しておりますが，動作を保証するものではありません．
                  掲載情報は自己責任の上でご利用ください．
                </p>
                <div class="table-wrap">
                  <table class="mdl-data-table mdl-js-data-table">
                    <tr>
                      <th class="mdl-data-table__cell--non-numeric">PIC</th>
                      <td class="mdl-data-table__cell--non-numeric">16F873A-I/SP</td>
                    </tr>
                    <tr>
                      <th class="mdl-data-table__cell--non-numeric">MPLAB X IDE</th>
                      <td class="mdl-data-table__cell--non-numeric">MPLAB X IDE v1.85 for Mac</td>
                    </tr>
                    <tr>
                      <th class="mdl-data-table__cell--non-numeric">MPLAB XC8</th>
                      <td class="mdl-data-table__cell--non-numeric">MPLAB XC8 C Compiler v1.20 for Mac</td>
                    </tr>
                    <tr>
                      <th class="mdl-data-table__cell--non-numeric">PICkit 2</th>
                      <td class="mdl-data-table__cell--non-numeric">MPLAB X IDEを使用して書込み</td>
                    </tr>
                  </table>
                </div>

                <h4>回路</h4>
                <h5>回路図</h5>
                <p>
                  今回は，自作にした汎用PICマイコンボードを使用しました．
                  下記のプログラムの動作に必要な部分を抜粋した回路は，下図の通りです．
                  下図の回路では，PICkit 2によるICSP (In Circuit Serial Programming)と電源供給を行うことし，回路部品数を必要最低限に抑えています．
                </p>
                <a href="img/pic_xc8_873a_pwm/schematic.png" data-lightbox="pwm" data-title="PWM方式LED調光回路">
                  <img src="img/pic_xc8_873a_pwm/schematic.png" alt="PWM方式LED調光回路" />
                </a>

                <h5>回路部品</h5>
                <p>
                  上記の回路図中で使用している回路部品のリストです．
                  参考単価は，特に記載がない限り，秋月電子通商で購入した場合のものです．
                </p>
                <div class="table-wrap">
                  <table class="mdl-data-table mdl-js-data-table">
                    <thead>
                      <tr>
                        <th class="mdl-data-table__cell--non-numeric">番号</th>
                        <th class="mdl-data-table__cell--non-numeric">部品名</th>
                        <th class="mdl-data-table__cell--non-numeric">型番</th>
                        <th>数量</th>
                        <th class="mdl-data-table__cell--non-numeric">参考単価</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td class="mdl-data-table__cell--non-numeric">U1</td>
                        <td class="mdl-data-table__cell--non-numeric">PICマイコン</td>
                        <td class="mdl-data-table__cell--non-numeric">Microchip 16F873A-I/SP</td>
                        <td>1</td>
                        <td class="mdl-data-table__cell--non-numeric">350円</td>
                      </tr>
                      <tr>
                        <td class="mdl-data-table__cell--non-numeric">X1</td>
                        <td class="mdl-data-table__cell--non-numeric">セラロック</td>
                        <td class="mdl-data-table__cell--non-numeric">村田製作所 20MHz</td>
                        <td>1</td>
                        <td class="mdl-data-table__cell--non-numeric">30円</td>
                      </tr>
                      <tr>
                        <td class="mdl-data-table__cell--non-numeric">LED1 - 2</td>
                        <td class="mdl-data-table__cell--non-numeric">LED</td>
                        <td class="mdl-data-table__cell--non-numeric">各社 &phi;5 高輝度タイプ 各色</td>
                        <td>2</td>
                        <td class="mdl-data-table__cell--non-numeric">10円</td>
                      </tr>
                      <tr>
                        <td class="mdl-data-table__cell--non-numeric">R1</td>
                        <td class="mdl-data-table__cell--non-numeric">炭素皮膜抵抗</td>
                        <td class="mdl-data-table__cell--non-numeric">各社 1/4W 10k&Omega;</td>
                        <td>1</td>
                        <td class="mdl-data-table__cell--non-numeric">1円</td>
                      </tr>
                      <tr>
                        <td class="mdl-data-table__cell--non-numeric">R2 - 3</td>
                        <td class="mdl-data-table__cell--non-numeric">炭素皮膜抵抗</td>
                        <td class="mdl-data-table__cell--non-numeric">各社 1/4W 330&Omega;</td>
                        <td>2</td>
                        <td class="mdl-data-table__cell--non-numeric">1円</td>
                      </tr>
                      <tr>
                        <td class="mdl-data-table__cell--non-numeric"></td>
                        <td class="mdl-data-table__cell--non-numeric">その他</td>
                        <td class="mdl-data-table__cell--non-numeric">リード線など</td>
                        <td>適量</td>
                        <td class="mdl-data-table__cell--non-numeric"></td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <h4>プログラム</h4>
                <p>
                  このプログラムはMPLAB XC8 C Compiler向けです．Cコンパイラの種類にご注意ください．
                </p>
                <p>
                  PIC16F873AにはCCPモジュールが2系統ありますので，これらを利用して2つのLEDの輝度を制御するプログラムです．
                  蛍の光のように，光が明るくなったり暗くなったりをゆっくりと繰り返します．
                  <em>
                  PWMの分解能は10bitですので，デューティ比設定用変数（duty1およびduty2）には0から1023までの値を設定可能です．
                  しかし，下記のプログラムではLEDの最大輝度を抑えるために最大値を511としています．
                  プログラムを改変して使用される場合はご注意ください．
                  LEDの最大輝度は，電流制限用抵抗であるR2およびR3の抵抗値でも調整可能です．
                  使用するLEDに合わせてデューティ比の最大値と電流制限用抵抗の抵抗値を調整してください．
                  </em>
                </p>
                <p>
                  下記はソースファイル「main.c」です．
                </p>
<pre><code class="language-c">
#include &lt;xc.h&gt;

#include "pwm.h"

#define _XTAL_FREQ 20000000   // 20MHz

#define PR2_DATA 0xFF

#pragma config BOREN = ON, CPD = OFF, DEBUG = OFF, WRT = OFF, FOSC = HS, WDTE = OFF, CP = OFF, LVP = OFF, PWRTE = ON

void main()
{
    unsigned int duty1, duty2;
    unsigned char flag1, flag2;
    
    TRISA = 0x00;       // PORTAの入出力設定
    TRISB = 0x00;       // PORTBの入出力設定
    TRISC = 0x00;       // PORTCの入出力設定
    PORTA = 0x00;       // PORTAを初期化
    PORTB = 0x00;       // PORTBを初期化
    PORTC = 0x00;       // PORTCを初期化
    
    initPWM1(PR2_DATA, T2_DIV_BY_1);    // CCP1をPWMモードに設定
    initPWM2(PR2_DATA, T2_DIV_BY_1);    // CCP2をPWMモードに設定
    setPWM1Duty(0);     // デューティ値を初期化
    setPWM2Duty(0);
    duty1 = 0;          // 制御変数を初期化
    flag1 = 0;
    duty2 = 511;
    flag2 = 1;
    
    while (1) {         // 無限ループ
        // CCP1 (PWM1)
        if (flag1 == 0) {   // デューティ比の変化方向の判定
            setPWM1Duty(duty1);     // デューティ比を設定
            duty1++;                // デューティ比をインクリメント
            if (duty1 >= 511) {     // デューティ比が最大値を超過した場合
                flag1 = 1;          // 変化方向を反転
            }
        }
        else {
            setPWM1Duty(duty1);
            duty1--;        // デューティ比をデクリメント
            if (duty1 <= 0) {
                flag1 = 0;
            }
        }
        // CCP2 (PWM2)
        if (flag2 == 0) {   // デューティ比の変化方向の判定
            setPWM2Duty(duty2);     // デューティ比を設定
            duty2++;                // デューティ比をインクリメント
            if (duty2 >= 511) {     // デューティ比が最大値を超過した場合
                flag2 = 1;          // 変化方向を反転
            }
        }
        else {
            setPWM2Duty(duty2);
            duty2--;      // デューティ比をデクリメント
            if (duty2 <= 0) {
                flag2 = 0;
            }
        }
        __delay_ms(5);      // 5ミリ秒タイマ
    }
}
</code></pre>
                <p>
                  下記はヘッダファイル「pwm.h」です．
                </p>
<pre><code class="language-c">
#ifndef PWM_H
#define PWM_H

#define T2_DIV_BY_1 0b00000000
#define T2_DIV_BY_4 0b00000001
#define T2_DIV_BY_16 0b00000010

#define CCP_PWM 0b00001100

// プロトタイプ宣言
void initPWM1(unsigned char pr2, unsigned char t2ckps);
void setPWM1Duty(unsigned int duty);
void initPWM2(unsigned char pr2, unsigned char t2ckps);
void setPWM2Duty(unsigned int duty);

#endif  // PWM_H
</code></pre>
<p>
下記はソースファイル「pwm.c」です．
</p>
<pre><code class="language-c">
#include &lt;xc.h&gt;

#include "pwm.h"

void initPWM1(unsigned char pr2, unsigned char t2ckps)
{
    PR2 = pr2;
    CCP1CON = CCP_PWM;
    setPWM1Duty(0);
    T2CON = t2ckps;
    T2CON |= 0x04;
}

void setPWM1Duty(unsigned int duty)
{
    CCPR1L = duty >> 2;
    CCP1CON &= 0b11001111;
    CCP1CON |= 0b00110000 & (duty << 4);
}

void initPWM2(unsigned char pr2, unsigned char t2ckps)
{
    PR2 = pr2;
    CCP2CON = CCP_PWM;
    setPWM2Duty(0);
    T2CON = t2ckps;
    T2CON |= 0x04;
}

void setPWM2Duty(unsigned int duty)
{
    CCPR2L = duty >> 2;
    CCP2CON &= 0b11001111;
    CCP2CON |= 0b00110000 & (duty << 4);
}
</code></pre>

                <h4>実装</h4>
                <h5>回路構成例</h5>
                <p>
                  今回は，自作にした汎用PICマイコンボードを使用しました．
                  LEDは上側からLED1 (RC1, CCP2)，LED2 (RC2, CCP1)です．
                </p>
                <a href="img/pic_xc8_873a_pwm/circuit.jpg" data-lightbox="pwm" data-title="PWM方式LED調光回路">
                  <img src="img/pic_xc8_873a_pwm/circuit.jpg" alt="PWM方式LED調光回路" />
                </a>

                <h5>動作例</h5>
                <p>
                  上記のプログラムを実際に動作させたときの映像です．
                </p>
                <div class="figure">
                  <iframe class="youtube-video-player" width="640" height="360" src="//www.youtube.com/embed/xo_DhydkQUA" frameborder="0" allowfullscreen></iframe>
                </div>

                <h4>__delay_ms関数にエラーマークが表示されるときは</h4>
                <p>
                  文法や関数の利用方法に問題がなくコンパイルが成功するにも関わらず，
                  __delay_ms関数や__delay_us関数にエラー（警告）マークが表示される場合，下記の記事をご一読ください．
                </p>
                <ul>
                  <li>blog 渓鉄: <a href="http://keitetsu.blogspot.jp/2013/10/mplab-xxc8delayms.html" target="_blank">MPLAB X+XC8で__delay_ms関数にエラーマークが表示される問題の解決方法</a></li>
                </ul>

                <h4>更新履歴</h4>
                <div class="table-wrap">
                  <table class="mdl-data-table mdl-js-data-table">
                    <thead>
                      <tr>
                        <th class="mdl-data-table__cell--non-numeric"">日付</th>
                        <th class="mdl-data-table__cell--non-numeric">内容</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td class="mdl-data-table__cell--non-numeric">2014/07/02</td>
                        <td class="mdl-data-table__cell--non-numeric">
                        関数定義を「pwm.h」から「pwm.c」に移行
                        </td>
                      </tr>
                      <tr>
                        <td class="mdl-data-table__cell--non-numeric">2014/06/29</td>
                        <td class="mdl-data-table__cell--non-numeric">
                        一部の記号定数定義を「main.c」から「pwm.h」に移行
                        </td>
                      </tr>
                      <tr>
                        <td class="mdl-data-table__cell--non-numeric">2014/05/19</td>
                        <td class="mdl-data-table__cell--non-numeric">
                        「pwm.h」にインクルードガードを追記
                        </td>
                      </tr>
                      <tr>
                        <td class="mdl-data-table__cell--non-numeric">2013/--/--</td>
                        <td class="mdl-data-table__cell--non-numeric">
                        公開開始
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </section>
            </div>
            <div class="mdl-grid">
              <div class="mdl-cell mdl-cell--6-col">
                <div class="mdl-cell--amazon-banner">
                  <iframe class="amazon-banner-2" src="https://rcm-fe.amazon-adsystem.com/e/cm?o=9&p=12&l=ez&f=ifr&linkID=a7ec7ffcf94f21c2beaf0e9d83c8042d&t=keitetsu-22&tracking_id=keitetsu-22" width="300" height="250" style="border:none;"></iframe>
                </div>
              </div>
              <div class="mdl-cell mdl-cell--6-col">
                <div class="mdl-cell--amazon-banner">
                  <iframe class="amazon-banner-2" src="https://rcm-fe.amazon-adsystem.com/e/cm?o=9&p=12&l=ur1&category=consumables&banner=01FFPGM6WNKYF9VQMHR2&f=ifr&linkID=8787af772f93befc97ae2df9f989341c&t=keitetsu-22&tracking_id=keitetsu-22" width="300" height="250" style="border:none;"></iframe>
                </div>
              </div>
            </div>
          </div>
          <div class="mdl-cell mdl-cell--2-col-desktop mdl-cell--2-col-tablet mdl-cell--hide-phone">
            <div class="mdl-cell--amazon-banner">
              <iframe class="amazon-banner-1" src="https://rcm-fe.amazon-adsystem.com/e/cm?o=9&p=11&l=ez&f=ifr&linkID=94c5721e7acc89e5886e59b6c10e7739&t=keitetsu-22&tracking_id=keitetsu-22" width="120" height="600" style="border:none;"></iframe>
            </div>
          </div>
        </div>
        <footer class="mdl-mini-footer">
          <div class="mdl-mini-footer__left-section">
            <div class="mdl-logo">&copy; 2004-<script>showNowYear();</script> Keitetsu</div>
          </div>
          <div class="mdl-mini-footer__right-section">
            <ul class="mdl-mini-footer__link-list">
              <li><a href="index.html#help">Help</a></li>
            </ul>
          </div>
        </footer>
      </main>
    </div>
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>
    <script src="js/highlight.pack.js"></script>
    <script>hljs.highlightAll();</script>
  </body>
</html>
